<div class="highlight"><pre><span class="k">def</span> <span class="nf">id_for_document</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">doc_id</span> <span class="o">=</span> <span class="vg">$redis</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">doc_id</span><span class="o">.</span><span class="n">nil?</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="vg">$redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;next_document_id&quot;</span><span class="p">)</span> 
        <span class="vg">$redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s2">&quot;documents&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">)</span> 
        <span class="vg">$redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s2">&quot;filenames&quot;</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">doc_id</span> 
<span class="k">end</span>

<span class="no">STOP_WORDS</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;the&quot;</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;it&quot;</span><span class="p">,</span> <span class="s2">&quot;you&quot;</span><span class="p">,</span> <span class="s2">&quot;that&quot;</span><span class="o">]</span> <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">doc_id</span> <span class="o">=</span> <span class="n">id_for_document</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span>
    <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/ |,|\)|\(|\;|\./</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
        <span class="n">continue</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">||</span> <span class="no">STOP_WORDS</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> 
        <span class="n">add_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>