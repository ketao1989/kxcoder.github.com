<div class="highlight"><pre><span class="c1">// 主线程池控制状态 ctl，表示当前有效地线程数，此外还可以指示是否是running、shutdown等状态</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AtomicInteger</span><span class="o">(</span><span class="n">ctlOf</span><span class="o">(</span><span class="n">RUNNING</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">COUNT_BITS</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">SIZE</span> <span class="o">-</span> <span class="mi">3</span><span class="o">;</span> <span class="c1">//Integer.SIZE = 32</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CAPACITY</span>   <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">COUNT_BITS</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span><span class="c1">// 00011111111111111111111111111111</span>

<span class="cm">/**</span>
<span class="cm"> * RUNNING -&amp;gt; SHUTDOWN</span>
<span class="cm"> *    On invocation of shutdown(), perhaps implicitly in finalize()</span>
<span class="cm"> * (RUNNING or SHUTDOWN) -&amp;gt; STOP</span>
<span class="cm"> *    On invocation of shutdownNow()</span>
<span class="cm"> * SHUTDOWN -&amp;gt; TIDYING</span>
<span class="cm"> *    When both queue and pool are empty</span>
<span class="cm"> * STOP -&amp;gt; TIDYING</span>
<span class="cm"> *    When pool is empty</span>
<span class="cm"> * TIDYING -&amp;gt; TERMINATED</span>
<span class="cm"> *    When the terminated() hook method has completed</span>
<span class="cm"> */</span>

<span class="c1">// runState 一共5种，使用高位的3位即可完全表示</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RUNNING</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">COUNT_BITS</span><span class="o">;</span> <span class="c1">// 11100000000000000000000000000000</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SHUTDOWN</span>   <span class="o">=</span>  <span class="mi">0</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">COUNT_BITS</span><span class="o">;</span> <span class="c1">// 00000000000000000000000000000000</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STOP</span>       <span class="o">=</span>  <span class="mi">1</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">COUNT_BITS</span><span class="o">;</span> <span class="c1">// 00100000000000000000000000000000</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TIDYING</span>    <span class="o">=</span>  <span class="mi">2</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">COUNT_BITS</span><span class="o">;</span> <span class="c1">// 01000000000000000000000000000000</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TERMINATED</span> <span class="o">=</span>  <span class="mi">3</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">COUNT_BITS</span><span class="o">;</span> <span class="c1">// 01100000000000000000000000000000</span>

<span class="c1">// Packing and unpacking ctl</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">runStateOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span>     <span class="o">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="o">~</span><span class="n">CAPACITY</span><span class="o">;</span> <span class="o">}</span> <span class="c1">//获取线程的状态</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">workerCountOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span>  <span class="o">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">CAPACITY</span><span class="o">;</span> <span class="o">}</span> <span class="c1">//获取线程池的线程数</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">ctlOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">wc</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">rs</span> <span class="o">|</span> <span class="n">wc</span><span class="o">;</span> <span class="o">}</span> <span class="c1">//获取某一状态的值 </span>
</pre></div>