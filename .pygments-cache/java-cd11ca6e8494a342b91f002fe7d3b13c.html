<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * 抽象的javax.sql.DataSource实现，可以完成基于一个查找key来路由 #getConnection()到某些特性目标DataSourcesd的一个。</span>
<span class="cm"> * 一般通过绑定线程事务上下文来决定。</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractRoutingDataSource</span> <span class="kd">extends</span> <span class="n">AbstractDataSource</span> <span class="kd">implements</span> <span class="n">InitializingBean</span> <span class="o">{</span>

<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">targetDataSources</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Object</span> <span class="n">defaultTargetDataSource</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">lenientFallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">DataSourceLookup</span> <span class="n">dataSourceLookup</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JndiDataSourceLookup</span><span class="o">();</span>

    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">DataSource</span><span class="o">&gt;</span> <span class="n">resolvedDataSources</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">resolvedDefaultDataSource</span><span class="o">;</span>


    <span class="cm">/**</span>
<span class="cm">     * 设置目标DataSources的map映射，其中查找key作为 map的key。</span>
<span class="cm">     * 这个映射的value可以是对象的DataSource实例，或者是一个数据源 name的字符串（可以被DataSourceLookup解析）。</span>
<span class="cm">     *</span>
<span class="cm">     * key可以是任意的类型，只要实现了普通的查找处理。</span>
<span class="cm">     * 具体的key表示形式，将会被resolveSpecifiedLookupKey和determineCurrentLookupKey处理</span>
<span class="cm">     *</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTargetDataSources</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">targetDataSources</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">targetDataSources</span> <span class="o">=</span> <span class="n">targetDataSources</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 设置默认目标数据源。如果我们在map中找不到对应的key时，则会使用这里设置的默认数据源</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefaultTargetDataSource</span><span class="o">(</span><span class="n">Object</span> <span class="n">defaultTargetDataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">defaultTargetDataSource</span> <span class="o">=</span> <span class="n">defaultTargetDataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 指定默认的DataSource，当通过指定的查找key不能找到对应的DataSource。</span>
<span class="cm">     * 如果为false，则直接返回失败，如果为true，则使用默认的数据源。默认为true</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLenientFallback</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">lenientFallback</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lenientFallback</span> <span class="o">=</span> <span class="n">lenientFallback</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 设置DataSourceLookup的实现类，该实现类可以把字符串配置的数据源，解析成我们需要的DataSource类.默认使用JndiDataSourceLookup。</span>
<span class="cm">     *</span>
<span class="cm">     * JndiDataSourceLookup方法使用ref bean方式获取配置文件中配置的dataSource数据源，也就是我们一般使用xml中配置datasource的方式就是jndi。</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDataSourceLookup</span><span class="o">(</span><span class="n">DataSourceLookup</span> <span class="n">dataSourceLookup</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSourceLookup</span> <span class="o">=</span> <span class="o">(</span><span class="n">dataSourceLookup</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">dataSourceLookup</span> <span class="o">:</span> <span class="k">new</span> <span class="nf">JndiDataSourceLookup</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">targetDataSources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Property &#39;targetDataSources&#39; is required&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">resolvedDataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">DataSource</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">targetDataSources</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">targetDataSources</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">lookupKey</span> <span class="o">=</span> <span class="n">resolveSpecifiedLookupKey</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
            <span class="n">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">resolveSpecifiedDataSource</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">resolvedDataSources</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lookupKey</span><span class="o">,</span> <span class="n">dataSource</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultTargetDataSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">resolvedDefaultDataSource</span> <span class="o">=</span> <span class="n">resolveSpecifiedDataSource</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultTargetDataSource</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据lookupKey获取map中存放的key值，一般无特性情况，两者是一样的</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">resolveSpecifiedLookupKey</span><span class="o">(</span><span class="n">Object</span> <span class="n">lookupKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lookupKey</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**</span>
<span class="cm">     * 转换从获取map中存放的dataSource</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">DataSource</span> <span class="nf">resolveSpecifiedDataSource</span><span class="o">(</span><span class="n">Object</span> <span class="n">dataSource</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="k">instanceof</span> <span class="n">DataSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">DataSource</span><span class="o">)</span> <span class="n">dataSource</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">dataSourceLookup</span><span class="o">.</span><span class="na">getDataSource</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">dataSource</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">&quot;Illegal data source value - only [javax.sql.DataSource] and String supported: &quot;</span> <span class="o">+</span> <span class="n">dataSource</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 这里就是抽象类给我们实现的接口方法，根据我们的配置上下文，抽象类决定实现哪个连接</span>
    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">determineTargetDataSource</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">determineTargetDataSource</span><span class="o">().</span><span class="na">getConnection</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">DataSource</span> <span class="nf">determineTargetDataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resolvedDataSources</span><span class="o">,</span> <span class="s">&quot;DataSource router not initialized&quot;</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">lookupKey</span> <span class="o">=</span> <span class="n">determineCurrentLookupKey</span><span class="o">();</span>
        <span class="n">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resolvedDataSources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lookupKey</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">lenientFallback</span> <span class="o">||</span> <span class="n">lookupKey</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">dataSource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resolvedDefaultDataSource</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Cannot determine target DataSource for lookup key [&quot;</span> <span class="o">+</span> <span class="n">lookupKey</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//这里是我们使用这个抽象类需要实现的方法，主要就是告诉该抽象类，当前需要使用的数据源的key是什么，这样抽象类就可以知道使用哪个数据库连接</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">determineCurrentLookupKey</span><span class="o">();</span>
</pre></div>